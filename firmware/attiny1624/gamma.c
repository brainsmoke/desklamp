
#include <stdint.h>

#include "config.h"

#define GAMMA_MIN (10)
#define GAMMA_DEFAULT (20)
#define GAMMA_MAX (55)

/* N tables with 33 entries packed into N*32+1 entries, next table's 0 doubles as 0x10000 */
/* so don't change the type from uint16_t */

static const uint16_t gamma_table[ (1+GAMMA_MAX-GAMMA_MIN)*32 + 1] =
{
/*
for i in range(10,55+1):
    g = i/10
    f = 65536/(32**g)
    print ('\t'+', '.join(str(int(.5+f*x**g)) for x in range(32)) + ',')
print("\t0")
*/
	0, 2048, 4096, 6144, 8192, 10240, 12288, 14336, 16384, 18432, 20480, 22528, 24576, 26624, 28672, 30720, 32768, 34816, 36864, 38912, 40960, 43008, 45056, 47104, 49152, 51200, 53248, 55296, 57344, 59392, 61440, 63488,
	0, 1448, 3104, 4849, 6654, 8505, 10394, 12315, 14263, 16236, 18231, 20246, 22280, 24331, 26397, 28478, 30574, 32682, 34803, 36935, 39079, 41234, 43399, 45574, 47758, 49952, 52154, 54364, 56583, 58810, 61045, 63287,
	0, 1024, 2353, 3827, 5405, 7064, 8792, 10578, 12417, 14302, 16229, 18196, 20198, 22235, 24303, 26400, 28526, 30679, 32857, 35059, 37285, 39533, 41803, 44093, 46404, 48734, 51082, 53449, 55833, 58234, 60652, 63086,
	0, 724, 1783, 3020, 4390, 5867, 7437, 9087, 10809, 12598, 14447, 16353, 18311, 20319, 22374, 24474, 26616, 28798, 31020, 33279, 35573, 37903, 40266, 42661, 45088, 47545, 50032, 52548, 55092, 57664, 60262, 62886,
	0, 512, 1351, 2384, 3566, 4873, 6290, 7806, 9410, 11097, 12861, 14697, 16601, 18569, 20599, 22688, 24834, 27033, 29285, 31588, 33940, 36339, 38785, 41275, 43809, 46386, 49004, 51663, 54361, 57099, 59874, 62687,
	0, 362, 1024, 1881, 2896, 4048, 5321, 6705, 8192, 9775, 11449, 13208, 15050, 16970, 18965, 21033, 23170, 25376, 27648, 29984, 32382, 34840, 37358, 39934, 42567, 45255, 47997, 50793, 53640, 56539, 59489, 62488,
	0, 256, 776, 1485, 2353, 3362, 4501, 5760, 7132, 8610, 10192, 11870, 13644, 15508, 17460, 19498, 21619, 23821, 26102, 28461, 30895, 33403, 35985, 38637, 41360, 44151, 47011, 49937, 52929, 55986, 59106, 62290,
	0, 181, 588, 1172, 1911, 2792, 3807, 4948, 6208, 7585, 9072, 10668, 12369, 14172, 16075, 18075, 20171, 22361, 24643, 27015, 29477, 32026, 34661, 37382, 40187, 43075, 46045, 49096, 52227, 55437, 58726, 62093,
	0, 128, 446, 925, 1552, 2319, 3220, 4250, 5405, 6681, 8076, 9588, 11213, 12951, 14799, 16756, 18820, 20990, 23265, 25643, 28123, 30705, 33386, 36168, 39047, 42024, 45098, 48269, 51534, 54894, 58348, 61896,
	0, 91, 338, 730, 1261, 1926, 2724, 3651, 4705, 5885, 7189, 8617, 10166, 11836, 13625, 15533, 17560, 19704, 21964, 24340, 26832, 29438, 32159, 34993, 37940, 41000, 44172, 47455, 50851, 54356, 57973, 61700,
	0, 64, 256, 576, 1024, 1600, 2304, 3136, 4096, 5184, 6400, 7744, 9216, 10816, 12544, 14400, 16384, 18496, 20736, 23104, 25600, 28224, 30976, 33856, 36864, 40000, 43264, 46656, 50176, 53824, 57600, 61504,
	0, 45, 194, 455, 832, 1329, 1949, 2694, 3566, 4566, 5697, 6960, 8355, 9884, 11549, 13349, 15287, 17362, 19577, 21930, 24425, 27060, 29837, 32756, 35819, 39025, 42375, 45870, 49510, 53297, 57229, 61309,
	0, 32, 147, 359, 676, 1104, 1648, 2314, 3104, 4022, 5072, 6255, 7574, 9033, 10632, 12375, 14263, 16298, 18482, 20817, 23303, 25944, 28740, 31692, 34803, 38073, 41504, 45097, 48854, 52775, 56861, 61115,
	0, 23, 111, 283, 549, 917, 1394, 1988, 2702, 3543, 4515, 5621, 6867, 8255, 9789, 11472, 13308, 15299, 17449, 19759, 22233, 24874, 27683, 30663, 33816, 37145, 40651, 44338, 48206, 52258, 56496, 60921,
	0, 16, 84, 223, 446, 761, 1179, 1707, 2353, 3121, 4019, 5052, 6225, 7544, 9012, 10635, 12417, 14361, 16473, 18755, 21213, 23848, 26665, 29667, 32857, 36239, 39816, 43591, 47566, 51746, 56132, 60728,
	0, 11, 64, 176, 362, 632, 998, 1467, 2048, 2749, 3578, 4540, 5644, 6894, 8297, 9859, 11585, 13481, 15552, 17803, 20239, 22864, 25684, 28703, 31925, 35355, 38998, 42856, 46935, 51239, 55771, 60535,
	0, 8, 49, 139, 294, 525, 844, 1260, 1783, 2422, 3185, 4080, 5116, 6300, 7639, 9140, 10809, 12655, 14682, 16899, 19309, 21921, 24739, 27770, 31020, 34493, 38196, 42134, 46313, 50737, 55412, 60343,
	0, 6, 37, 110, 239, 436, 714, 1082, 1552, 2133, 2835, 3667, 4638, 5757, 7033, 8473, 10086, 11879, 13862, 16040, 18423, 21017, 23830, 26868, 30140, 33652, 37411, 41424, 45698, 50240, 55056, 60152,
	0, 4, 28, 87, 194, 362, 604, 930, 1351, 1879, 2524, 3296, 4205, 5261, 6475, 7854, 9410, 11151, 13086, 15225, 17577, 20150, 22953, 25995, 29285, 32832, 36643, 40727, 45092, 49748, 54702, 59962,
	0, 3, 21, 68, 158, 301, 511, 799, 1176, 1655, 2247, 2962, 3812, 4808, 5961, 7281, 8780, 10468, 12355, 14452, 16770, 19319, 22109, 25151, 28455, 32031, 35890, 40041, 44494, 49261, 54350, 59771,
	0, 2, 16, 54, 128, 250, 432, 686, 1024, 1458, 2000, 2662, 3456, 4394, 5488, 6750, 8192, 9826, 11664, 13718, 16000, 18522, 21296, 24334, 27648, 31250, 35152, 39366, 43904, 48778, 54000, 59582,
	0, 1, 12, 43, 104, 208, 365, 589, 891, 1284, 1780, 2392, 3133, 4015, 5053, 6257, 7643, 9224, 11012, 13021, 15265, 17758, 20513, 23544, 26864, 30488, 34430, 38703, 43322, 48300, 53653, 59393,
	0, 1, 9, 34, 84, 172, 309, 506, 776, 1131, 1585, 2150, 2840, 3670, 4652, 5801, 7132, 8658, 10396, 12360, 14565, 17026, 19758, 22779, 26102, 29745, 33722, 38051, 42747, 47827, 53307, 59205,
	0, 1, 7, 27, 69, 143, 261, 435, 676, 997, 1411, 1932, 2575, 3353, 4283, 5378, 6654, 8128, 9815, 11732, 13896, 16323, 19032, 22039, 25362, 29019, 33029, 37410, 42180, 47359, 52965, 59017,
	0, 1, 5, 21, 56, 119, 221, 374, 588, 878, 1256, 1737, 2334, 3065, 3943, 4985, 6208, 7630, 9266, 11136, 13258, 15650, 18332, 21323, 24643, 28312, 32350, 36780, 41621, 46895, 52624, 58830,
	0, 0, 4, 17, 45, 99, 187, 321, 512, 773, 1118, 1561, 2116, 2801, 3630, 4621, 5793, 7162, 8748, 10570, 12649, 15005, 17658, 20630, 23944, 27621, 31686, 36160, 41068, 46435, 52285, 58644,
	0, 0, 3, 13, 37, 82, 158, 276, 446, 681, 995, 1403, 1919, 2559, 3342, 4284, 5405, 6723, 8259, 10034, 12068, 14386, 17008, 19960, 23265, 26948, 31034, 35551, 40524, 45980, 51949, 58458,
	0, 0, 2, 10, 30, 68, 134, 237, 388, 600, 886, 1261, 1739, 2339, 3077, 3972, 5043, 6311, 7797, 9524, 11514, 13792, 16383, 19312, 22605, 26291, 30397, 34952, 39986, 45530, 51615, 58272,
	0, 0, 2, 8, 24, 57, 113, 203, 338, 528, 789, 1133, 1577, 2137, 2833, 3682, 4705, 5924, 7361, 9040, 10986, 13223, 15780, 18684, 21964, 25650, 29772, 34363, 39456, 45084, 51283, 58088,
	0, 0, 1, 6, 20, 47, 96, 175, 294, 466, 702, 1018, 1430, 1953, 2608, 3413, 4390, 5561, 6950, 8581, 10481, 12678, 15200, 18077, 21341, 25024, 29160, 33784, 38932, 44642, 50953, 57904,
	0, 0, 1, 5, 16, 39, 81, 150, 256, 410, 625, 915, 1296, 1785, 2401, 3164, 4096, 5220, 6561, 8145, 10000, 12155, 14641, 17490, 20736, 24414, 28561, 33215, 38416, 44205, 50625, 57720,
	0, 0, 1, 4, 13, 32, 69, 129, 223, 361, 556, 822, 1175, 1631, 2210, 2933, 3822, 4900, 6194, 7731, 9541, 11654, 14103, 16922, 20148, 23819, 27974, 32656, 37906, 43772, 50299, 57537,
	0, 0, 1, 3, 11, 27, 58, 111, 194, 318, 495, 739, 1065, 1491, 2035, 2719, 3566, 4600, 5848, 7339, 9103, 11173, 13584, 16372, 19577, 23238, 27399, 32105, 37404, 43343, 49976, 57355,
	0, 0, 0, 2, 9, 22, 49, 95, 169, 280, 441, 664, 966, 1362, 1874, 2521, 3327, 4318, 5521, 6966, 8685, 10712, 13084, 15840, 19021, 22671, 26836, 31565, 36907, 42919, 49654, 57173,
	0, 0, 0, 2, 7, 19, 41, 82, 147, 247, 392, 597, 875, 1245, 1725, 2337, 3104, 4053, 5212, 6612, 8286, 10270, 12603, 15326, 18482, 22119, 26285, 31033, 36418, 42498, 49335, 56992,
	0, 0, 0, 2, 6, 15, 35, 70, 128, 217, 349, 537, 794, 1138, 1588, 2166, 2896, 3805, 4921, 6276, 7906, 9847, 12140, 14828, 17958, 21579, 25745, 30510, 35935, 42082, 49017, 56811,
	0, 0, 0, 1, 5, 13, 30, 60, 111, 192, 311, 482, 719, 1040, 1462, 2008, 2702, 3572, 4646, 5957, 7543, 9441, 11693, 14346, 17449, 21053, 25215, 29996, 35458, 41670, 48702, 56631,
	0, 0, 0, 1, 4, 11, 25, 52, 97, 169, 277, 433, 652, 950, 1346, 1862, 2521, 3353, 4386, 5655, 7196, 9051, 11263, 13880, 16954, 20540, 24697, 29491, 34988, 41262, 48389, 56451,
	0, 0, 0, 1, 3, 9, 21, 44, 84, 149, 246, 389, 591, 868, 1239, 1726, 2353, 3147, 4141, 5368, 6866, 8678, 10849, 13429, 16473, 20039, 24190, 28994, 34524, 40857, 48078, 56272,
	0, 0, 0, 1, 2, 7, 18, 38, 74, 131, 219, 350, 536, 794, 1141, 1600, 2195, 2954, 3909, 5095, 6551, 8320, 10450, 12993, 16006, 19550, 23693, 28505, 34066, 40457, 47768, 56094,
	0, 0, 0, 0, 2, 6, 15, 33, 64, 115, 195, 315, 486, 725, 1050, 1483, 2048, 2773, 3691, 4836, 6250, 7977, 10066, 12571, 15552, 19073, 23206, 28025, 33614, 40061, 47461, 55916,
	0, 0, 0, 0, 2, 5, 13, 28, 56, 102, 174, 283, 441, 663, 967, 1375, 1911, 2603, 3484, 4590, 5963, 7648, 9696, 12163, 15111, 18608, 22729, 27553, 33168, 39668, 47156, 55739,
	0, 0, 0, 0, 1, 4, 11, 24, 49, 89, 155, 254, 399, 606, 890, 1275, 1783, 2444, 3289, 4357, 5689, 7332, 9339, 11768, 14682, 18155, 22262, 27089, 32728, 39280, 46852, 55562,
	0, 0, 0, 0, 1, 3, 9, 21, 42, 79, 138, 228, 362, 553, 820, 1182, 1663, 2294, 3105, 4136, 5428, 7030, 8995, 11385, 14266, 17712, 21804, 26633, 32294, 38895, 46551, 55386,
	0, 0, 0, 0, 1, 3, 8, 18, 37, 69, 123, 205, 328, 506, 755, 1095, 1552, 2153, 2932, 3926, 5179, 6740, 8665, 11015, 13862, 17280, 21356, 26184, 31866, 38514, 46251, 55211,
	0, 0, 0, 0, 1, 2, 7, 15, 32, 61, 109, 184, 298, 462, 695, 1015, 1448, 2021, 2768, 3726, 4941, 6462, 8346, 10658, 13468, 16859, 20917, 25743, 31443, 38137, 45954, 55036,
	0
};

static uint8_t gamma = GAMMA_DEFAULT;
static const uint16_t *cur_table = &gamma_table[ (GAMMA_DEFAULT-GAMMA_MIN) * 32 ]; // (decimals)
static uint32_t limit = 0x10000;

void gamma_set(uint8_t gamma_dec) /* gamma = gamma_dec/10 */
{
	if (gamma_dec < GAMMA_MIN)
		gamma_dec = GAMMA_MIN;

	else if (gamma_dec > GAMMA_MAX)
		gamma_dec = GAMMA_MAX;

	gamma = gamma_dec;
	cur_table = &gamma_table[ (gamma_dec - GAMMA_MIN) * 32 ];
}

uint8_t gamma_get(void)
{
	return gamma;
}

void gamma_set_max(uint16_t max)
{
	limit = (uint32_t)max+1; /* ((max+1)*0xffff)>>16 is max */
}

uint16_t gamma_get_max(void)
{
	return limit-1;
}

uint16_t gamma_translate(uint16_t v)
{
	uint8_t ix = v>>11;
	uint16_t diff = cur_table[ix+1] - cur_table[ix]; /* make use of integer wraparound if ix == 32 */
	uint32_t res = v&0x7ff;

	res *= diff;
	res >>= 11;
	res += cur_table[ix];
	res *= limit;
	return res >> 16;
}

